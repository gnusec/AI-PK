# 司马迁 - 高性能端口扫描器

> 基于Zig语言开发的高性能端口扫描工具，类似rustscan，支持并发扫描和多种输出格式。

## 特性

- 🚀 **高性能**: 支持海量并发连接，默认500个并发
- 🎯 **灵活配置**: 支持端口列表、端口范围、自定义并发数和超时时间
- 📊 **多种输出格式**: 支持普通文本、JSON、纯文本列表格式
- 🛡️ **智能超时控制**: 严格控制测试和编译过程中的超时机制
- 🔧 **全自动测试流程**: 内置自动化测试脚本，支持真实外网IP测试
- 🌐 **跨平台支持**: 支持Linux、Windows、macOS等多平台编译

## 快速开始

### 编译项目

```bash
# 克隆项目
git clone <repository-url>
cd simaqian

# 编译项目
chmod +x scripts/build.sh
./scripts/build.sh

# 或者使用zig build
zig build -Doptimize=ReleaseFast
```

### 基本使用

```bash
# 查看帮助信息
zig-out/bin/simaqian --help

# 扫描指定端口
zig-out/bin/simaqian -p "80,443,8080" example.com

# 扫描端口范围
zig-out/bin/simaqian -r "1-1000" example.com

# 高并发扫描
zig-out/bin/simaqian -t 1000 -r "1-1000" example.com

# JSON格式输出
zig-out/bin/simaqian --format json example.com

# 纯文本端口列表输出
zig-out/bin/simaqian --format txt example.com
```

## 命令行选项

| 选项 | 简称 | 描述 | 示例 |
|------|------|------|------|
| `--help` | `-h` | 显示帮助信息 | |
| `--ports` | `-p` | 指定端口列表 | `-p "80,443,8080"` |
| `--range` | `-r` | 指定端口范围 | `-r "1-1000"` |
| `--concurrency` | `-t` | 设置并发连接数 | `-t 500` |
| `--timeout` | | 设置连接超时时间(ms) | `--timeout 2000` |
| `--format` | | 输出格式 | `--format json` |
| `--verbose` | `-v` | 启用详细输出 | |

## 输出格式

### 普通格式 (默认)
```
╔════════════════════════════════════════════════════════════════╗
║                        司马迁端口扫描器                        ║
╠════════════════════════════════════════════════════════════════╣
║ 目标主机: example.com                                      ║
║ 扫描端口: 1000                                             ║
║ 开放端口: 5                                                ║
║ 并发数: 500                                                ║
║ 超时时间: 2000ms                                           ║
║ 耗时: 1500ms                                               ║
╚════════════════════════════════════════════════════════════════╝

┌─────────────┬────────────┬────────────────┐
│    端口     │   状态     │  响应时间(ms)   │
├─────────────┼────────────┼────────────────┤
│ 80          │ 开放       │ 45             │
│ 443         │ 开放       │ 52             │
└─────────────┴────────────┴────────────────┘
```

### JSON格式
```json
{
  "target": "example.com",
  "scan_info": {
    "total_ports": 1000,
    "open_ports": 5,
    "concurrency": 500,
    "timeout_ms": 2000,
    "elapsed_ms": 1500
  },
  "ports": [
    {"port": 80, "status": "open", "response_time_ms": 45},
    {"port": 443, "status": "open", "response_time_ms": 52}
  ]
}
```

### 纯文本格式
```
80
443
8080
```

## 自动化测试

### 编译和测试
```bash
# 运行完整测试套件
chmod +x scripts/test.sh
./scripts/test.sh

# 编译并运行测试
zig build test

# 运行特定测试
zig test test_scanner.zig
```

### 网络测试验证
```bash
# 使用真实外网IP进行网络测试
chmod +x scripts/network_test.sh
./scripts/network_test.sh
```

### 交叉编译测试
```bash
# 编译到不同平台
./scripts/build.sh --cross x86_64-windows-gnu
./scripts/build.sh --cross aarch64-linux-gnu
./scripts/build.sh --cross x86_64-macos-none
```

## 项目结构

```
simaqian/
├── src/                    # 源代码目录
│   ├── main.zig           # 主程序入口
│   ├── scanner.zig        # 端口扫描器核心模块
│   ├── args.zig           # 命令行参数解析模块
│   └── output.zig         # 输出格式化模块
├── scripts/               # 脚本目录
│   ├── build.sh           # 编译脚本
│   ├── test.sh            # 自动化测试脚本
│   └── network_test.sh    # 网络测试验证脚本
├── test_scanner.zig       # 单元测试文件
├── build.zig             # Zig构建系统配置
├── README_PROJECT.md     # 项目文档
└── README                 # 原始需求文档
```

## 性能优化

### 并发控制
- 默认并发数：500
- 支持动态调整并发数以适应不同网络环境
- 自动负载均衡，避免资源耗尽

### 超时机制
- 默认连接超时：1000ms
- 支持自定义超时时间
- 严格的超时控制，避免无限等待

### 内存优化
- 使用内存池进行缓冲区管理
- 避免内存泄漏
- 高效的内存分配和释放

## 测试覆盖

### 单元测试
- ✅ 基本端口扫描功能
- ✅ 并发扫描机制
- ✅ 超时控制机制
- ✅ 输出格式化
- ✅ 边界条件处理
- ✅ 内存泄漏检测

### 集成测试
- ✅ 真实外网IP测试
- ✅ 不同端口范围测试
- ✅ 各种并发数测试
- ✅ 多种输出格式测试

### 性能测试
- ✅ 基准性能测试
- ✅ 压力测试
- ✅ 资源使用监控

## 最佳实践

### 安全使用
1. **遵守法律法规**: 只扫描您拥有或获得授权的系统
2. **合理并发数**: 过高的并发数可能导致网络拥塞或被封禁
3. **适当超时**: 根据网络环境调整超时时间
4. **监控资源**: 注意系统资源使用情况

### 性能调优
1. **从小范围开始**: 先从小端口范围测试，逐步扩大
2. **调整并发数**: 根据网络条件和系统性能调整并发数
3. **设置合理超时**: 避免过短的超时导致误报
4. **监控响应时间**: 注意异常的响应时间

### 故障排除
1. **网络连通性**: 确保目标主机可达
2. **防火墙限制**: 检查本地和远程防火墙设置
3. **权限问题**: 确保有足够的网络权限
4. **资源限制**: 检查系统资源使用情况

## 开发指南

### 添加新功能
1. 在相应模块中实现功能
2. 添加单元测试
3. 更新文档
4. 运行完整测试套件

### 代码规范
- 使用4空格缩进
- 遵循Zig命名约定
- 添加详细注释
- 编写测试用例

## 许可证

本项目遵循MIT许可证开源。

## 贡献

欢迎提交Issue和Pull Request！

## 作者

基于Zig语言开发的端口扫描工具，遵循Linus的KISS精神，注重代码简洁性和可靠性。

---

*注意：请确保在合法授权的情况下使用本工具，只扫描您拥有或获得授权的系统。*